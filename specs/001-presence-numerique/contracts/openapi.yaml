openapi: 3.0.0
info:
  title: Sygma Presence API
  version: "1.0.0"
  description: API for managing student presence via QR code and manual checklists.

paths:
  /api/sessions/{sessionId}/attendance:
    get:
      summary: Get current attendance status
      description: Fetches the real-time list of students and their status for a given session (for both QR and manual modes).
      tags:
        - Attendance
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: A list of students with their attendance status.
          content:
            application/json:
              schema:
                type: object
                properties:
                  total_enrolled:
                    type: integer
                  total_present:
                    type: integer
                  students:
                    type: array
                    items:
                      $ref: '#/components/schemas/StudentAttendance'
        '403':
          description: Forbidden. User is not the teacher for this session.
        '404':
          description: Session not found.

    post:
      summary: Submit manual attendance
      description: Allows a teacher to submit the complete attendance list from a manual check.
      tags:
        - Attendance
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                attendances:
                  type: array
                  items:
                    type: object
                    properties:
                      student_id:
                        type: integer
                      status:
                        type: string
                        enum: [present, absent]
      responses:
        '204':
          description: Attendance successfully recorded.
        '400':
          description: Invalid data provided.
        '403':
          description: Forbidden.

  /api/sessions/{sessionId}/attendance/start:
    post:
      summary: Start an attendance session
      description: Initiates the attendance process for a session, allowing the teacher to choose the method (QR or manual).
      tags:
        - Attendance
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                method:
                  type: string
                  enum: [qr, manual]
                  description: The desired attendance method.
      responses:
        '200':
          description: Method initiated. Returns a QR code image if 'qr' is chosen, or a confirmation for 'manual'.
          content:
            application/json:
              schema:
                type: object
                properties:
                  method:
                    type: string
                  qr_code_data_url:
                    type: string
                    format: uri
                    description: A base64-encoded image of the QR code. Only present if method is 'qr'.
                  expires_at:
                    type: string
                    format: date-time
                    description: The expiry time for the QR code. Only present if method is 'qr'.
        '403':
          description: Forbidden.
        '404':
          description: Session not found.

  /api/student/attendance/scan:
    post:
      summary: Scan QR Code
      description: Allows a student to mark themselves as present by submitting the content of a scanned QR code.
      tags:
        - Student
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                qr_code_content:
                  type: string
      responses:
        '200':
          description: Presence successfully recorded.
        '400':
          description: Invalid or expired QR code.
        '409':
          description: Conflict. Student already marked as present.

  /api/export/attendances:
    get:
      summary: Export attendance data
      description: Exports attendance records for a specified period, optionally filtered by course or other criteria.
      tags:
        - Manager
      parameters:
        - name: start_date
          in: query
          required: true
          schema:
            type: string
            format: date
          description: The start date for the export period (e.g., YYYY-MM-DD).
        - name: end_date
          in: query
          required: true
          schema:
            type: string
            format: date
          description: The end date for the export period (e.g., YYYY-MM-DD).
        - name: format
          in: query
          required: false
          schema:
            type: string
            enum: [csv, pdf]
            default: csv
          description: The desired export format.
      responses:
        '200':
          description: The requested data file.
          content:
            application/vnd.ms-excel:
              schema:
                type: string
                format: binary
            application/pdf:
              schema:
                type: string
                format: binary
        '400':
          description: Invalid date range or parameters.
        '403':
          description: Forbidden.

components:
  schemas:
    Student:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
    StudentAttendance:
      type: object
      properties:
        student_id:
          type: integer
        name:
          type: string
        status:
          type: string
          enum: [present, absent]
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer

security:
  - bearerAuth: []
