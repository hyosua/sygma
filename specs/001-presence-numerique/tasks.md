# Tasks: Digital Presence Management

**Input**: Design documents from `specs/001-presence-numerique/`
**Prerequisites**: plan.md (required), spec.md (required for user stories), research.md, data-model.md, contracts/

**Tests**: Tests are included as requested by the feature specification (User Scenarios & Testing mandatory).

**Organization**: Tasks are grouped by user story to enable independent implementation and testing of each story.

## Format: `[ID] [P?] [Story] Description`

- **[P]**: Can run in parallel (different files, no dependencies)
- **[Story]**: Which user story this task belongs to (e.g., US1, US2, US3)
- Exact file paths are included in descriptions

---

## Phase 1: Setup (Shared Infrastructure)

**Purpose**: Project initialization and basic structure

- [X] T001 Setup Docker Compose and environment files (`.env`) for backend, frontend, and db at repository root
- [X] T002 Initialize Laravel 11 project in `backend/`
- [X] T003 Initialize React 18 project in `frontend/`
- [X] T004 [P] Configure ESLint/Prettier in `frontend/` and PHP_CodeSniffer in `backend/`

---

## Phase 2: Foundational (Blocking Prerequisites)

**Purpose**: Core infrastructure that MUST be complete before ANY user story can be implemented

**âš ï¸ CRITICAL**: No user story work can begin until this phase is complete

- [ ] T005 Create database migrations for all tables (users, roles, courses, sessions, emargements, attendances, enrollments) in `backend/database/migrations/`
- [ ] T006 Setup Laravel Sanctum for API authentication in `backend/app/Http/Kernel.php` and `backend/routes/api.php`
- [ ] T007 [P] Setup Spatie Laravel-permission and seed initial roles (Etudiant, Professeur, Gestionnaire) in `backend/database/seeders/RolesAndPermissionsSeeder.php`
- [ ] T008 [P] Create Eloquent models (User, Role, Course, CourseSession, EmargementSession, Attendance) in `backend/app/Models/`
- [ ] T009 Setup global API error handling and logging in `backend/app/Exceptions/Handler.php`

**Checkpoint**: Foundation ready - user story implementation can now begin in parallel

---

## Phase 3: User Story 1 - Marquage de PrÃ©sence via QR Code (Priority: P1) ðŸŽ¯ MVP

**Goal**: Enable students to scan a dynamic QR code generated by a professor to mark their presence.

**Independent Test**: Prof starts a session, QR is displayed. Student scans it via API/mobile view. Presence record is created and Prof view updates.

### Tests for User Story 1

- [ ] T010 [P] [US1] Feature test for QR session initiation in `backend/tests/Feature/AttendanceSessionTest.php`
- [ ] T011 [P] [US1] Feature test for Student QR scan in `backend/tests/Feature/StudentAttendanceTest.php`

### Implementation for User Story 1

- [ ] T012 [US1] Implement `POST /api/sessions/{sessionId}/attendance/start` for starting QR emargement in `backend/app/Http/Controllers/AttendanceController.php`
- [ ] T013 [US1] Implement QR Code generation service using `simple-qrcode` in `backend/app/Services/QRCodeService.php`
- [ ] T014 [US1] Implement `POST /api/student/attendance/scan` with token and geolocation validation in `backend/app/Http/Controllers/StudentAttendanceController.php`
- [ ] T015 [US1] Implement real-time attendance status `GET /api/sessions/{sessionId}/attendance` in `backend/app/Http/Controllers/AttendanceController.php`
- [ ] T016 [P] [US1] Create Professor Session Control page with QR display in `frontend/src/pages/Professor/SessionQR.jsx`
- [ ] T017 [P] [US1] Create Student Scan interface using `html5-qrcode` in `frontend/src/pages/Student/ScanAttendance.jsx`

**Checkpoint**: User Story 1 is functional as an MVP increment.

---

## Phase 4: User Story 3 - Marquage de PrÃ©sence Manuel (Priority: P1)

**Goal**: Provide a fallback method for professors to manually mark attendance from a list.

**Independent Test**: Prof selects manual mode, sees list of enrolled students, checks "Present" for some, saves. Attendance records are updated.

### Tests for User Story 3

- [ ] T018 [P] [US3] Feature test for manual attendance submission in `backend/tests/Feature/ManualAttendanceTest.php`

### Implementation for User Story 3

- [ ] T019 [US3] Implement `POST /api/sessions/{sessionId}/attendance` for batch manual submission in `backend/app/Http/Controllers/AttendanceController.php`
- [ ] T020 [P] [US3] Create Manual Attendance checklist view in `frontend/src/pages/Professor/ManualChecklist.jsx`

**Checkpoint**: Professors can now choose between QR and Manual attendance.

---

## Phase 5: User Story 2 - Validation et Gestion par le Gestionnaire (Priority: P2)

**Goal**: Allow managers to review attendance sheets, modify status if needed, and export data.

**Independent Test**: Manager logs in, filters by period, sees sheets, modifies a status, and exports a CSV report.

### Tests for User Story 2

- [ ] T021 [P] [US2] Feature test for attendance export functionality in `backend/tests/Feature/ManagerExportTest.php`

### Implementation for User Story 2

- [ ] T022 [US2] Implement Manager dashboard for browsing and validating attendance sheets in `frontend/src/pages/Manager/Dashboard.jsx`
- [ ] T023 [US2] Implement `GET /api/export/attendances` for CSV/PDF reports using `maatwebsite/excel` in `backend/app/Http/Controllers/ExportController.php`
- [ ] T024 [US2] Implement final validation (locking) of attendance sheets in `backend/app/Http/Controllers/AttendanceController.php`

**Checkpoint**: Full administrative cycle complete.

---

## Phase 6: Polish & Cross-Cutting Concerns

**Purpose**: Final touches, notifications, and verification

- [ ] T025 [P] Implement absence notification system for managers in `backend/app/Services/NotificationService.php` (FR-020)
- [ ] T026 [P] Add responsive styling for mobile users in `frontend/src/styles/`
- [ ] T027 Conduct final security audit of QR token validation and geolocation checks
- [ ] T028 Run full validation against `quickstart.md` and `spec.md`

---

## Dependencies & Execution Order

### Phase Dependencies

- **Setup (Phase 1)**: No dependencies - MUST start immediately.
- **Foundational (Phase 2)**: Depends on Phase 1 completion - BLOCKS all user stories.
- **User Stories (Phase 3-5)**: All depend on Foundational completion. US1 and US3 can proceed in parallel (both P1).
- **Polish (Phase 6)**: Depends on completion of all P1 stories.

### Parallel Opportunities

- T004 can run while T002/T003 are initializing.
- T007 and T008 can run in parallel within Phase 2.
- Once Phase 2 is done, US1 (Phase 3), US2 (Phase 5), and US3 (Phase 4) can technically start in parallel, though US2 depends on having some data from US1/US3 to be meaningful.
- Frontend (T016, T017, T020, T022) can be developed in parallel with Backend tasks once API contracts are stable.

---

## Implementation Strategy

### MVP First (User Story 1 & 3)

1. Complete Setup and Foundational phases.
2. Implement User Story 1 (QR Attendance) as the core value.
3. Implement User Story 3 (Manual Attendance) as the essential fallback.
4. **Checkpoint**: Demonstrate a working professor-student attendance loop.

### Incremental Delivery

1. Foundation -> Core Presence (QR) -> Fallback Presence (Manual) -> Management (Validation/Export).
2. Each phase adds a layer of users: first Prof/Student, then Manager.
